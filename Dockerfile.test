# Dockerfile for Emergency Alerts Integration Backend Testing
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git \
    build-essential \
    gcc \
    g++ \
    make \
    python3-dev \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime \
    && echo "America/Los_Angeles" > /etc/timezone \
    && dpkg-reconfigure -f noninteractive tzdata

# Copy integration files
COPY custom_components/ ./custom_components/
COPY pyproject.toml ./
COPY pytest.ini ./
COPY custom_components/emergency_alerts/test_requirements.txt ./test_requirements.txt

# Install Python dependencies
RUN pip install --no-cache-dir -r test_requirements.txt pytz

ENV PYTHONPATH="/app:/usr/local/lib/python3.11/site-packages"
ENV TZ=UTC

# Create test runner script
RUN echo '#!/bin/bash\nset -e\necho "ðŸš¦ Running Emergency Alerts Integration Backend Tests"\necho "Working directory: $(pwd)"\necho "Python version: $(python --version)"\necho "Timezone: $(cat /etc/timezone)"\necho ""\necho "Test files:"\nfind custom_components/emergency_alerts/tests -name "test_*.py" -type f | sort\necho ""\npytest custom_components/emergency_alerts/tests/ --cov=custom_components.emergency_alerts --cov-report=term-missing -v' > /app/run_tests.sh && chmod +x /app/run_tests.sh

# Set timezone environment
ENV TZ=America/Los_Angeles

ENTRYPOINT ["/app/run_tests.sh"] 